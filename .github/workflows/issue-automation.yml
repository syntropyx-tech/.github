name: Issue automation

on:
  workflow_call:
    secrets:
      REPO_PROJECTS_PAT:
        required: false

jobs:
  add-domain-label:
    name: Add domain label
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const domainMatch = body.match(/### Domain\s*\n\s*(Admin|API|DevOps|UI|Quant|Smart Contracts)/i);

            if (domainMatch) {
              let domain = domainMatch[1].toLowerCase();
              // Map "smart contracts" to "contracts" label
              if (domain === 'smart contracts') {
                domain = 'contracts';
              }
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [domain]
              });
              console.log(`Added label: ${domain}`);
            }

  set-issue-type:
    name: Set issue type
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);

            let issueType = null;
            if (labels.includes('bug')) {
              issueType = 'Bug';
            } else if (labels.includes('feature')) {
              issueType = 'Feature';
            } else if (labels.includes('chore') || labels.includes('spike') || labels.includes('refactor')) {
              issueType = 'Task';
            }

            if (issueType) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                type: issueType
              });
              console.log(`Set issue type: ${issueType}`);
            }

  add-to-project:
    name: Add to project board
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.REPO_PROJECTS_PAT }}
      PROJECT_NUMBER: 1
      ORG: syntropyx-tech
      # Field IDs (from project configuration)
      STATUS_FIELD_ID: "PVTSSF_lADODJHCj84BLGUfzg6xfy8"
      PRIORITY_FIELD_ID: "PVTSSF_lADODJHCj84BLGUfzg6xiqo"
    steps:
      - name: Check for token
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::error::Missing REPO_PROJECTS_PAT secret"
            exit 1
          fi

      - name: Add issue to project and set fields
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GH_TOKEN }}
          script: |
            const body = context.payload.issue.body || '';
            const issueNodeId = context.payload.issue.node_id;

            const priorityMatch = body.match(/### Priority\s*\n\s*(Critical|High|Medium|Low)/i);
            const priority = priorityMatch ? priorityMatch[1] : null;

            const statusMatch = body.match(/### Status\s*\n\s*(Backlog|Icebox|In Progress|Blocked)/i);
            const status = statusMatch ? statusMatch[1] : 'Backlog';

            const priorityOptions = {
              'critical': '3f6f6ab8',
              'high': '0226f50d',
              'medium': '7d9e0275',
              'low': '1fc9878b'
            };

            const statusOptions = {
              'backlog': 'f75ad846',
              'icebox': '378c0c48',
              'in progress': '47fc9ee4',
              'blocked': '2cdfa413'
            };

            const projectQuery = await github.graphql(`
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) { id }
                }
              }
            `, {
              org: process.env.ORG,
              number: parseInt(process.env.PROJECT_NUMBER)
            });
            const projectId = projectQuery.organization.projectV2.id;

            const addResult = await github.graphql(`
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item { id }
                }
              }
            `, { projectId, contentId: issueNodeId });
            const itemId = addResult.addProjectV2ItemById.item.id;

            const statusOptionId = statusOptions[status.toLowerCase()];
            if (statusOptionId) {
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId, itemId: $itemId, fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) { projectV2Item { id } }
                }
              `, {
                projectId, itemId,
                fieldId: process.env.STATUS_FIELD_ID,
                optionId: statusOptionId
              });
            }

            if (priority) {
              const priorityOptionId = priorityOptions[priority.toLowerCase()];
              if (priorityOptionId) {
                await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId, itemId: $itemId, fieldId: $fieldId,
                      value: { singleSelectOptionId: $optionId }
                    }) { projectV2Item { id } }
                  }
                `, {
                  projectId, itemId,
                  fieldId: process.env.PRIORITY_FIELD_ID,
                  optionId: priorityOptionId
                });
              }
            }

            console.log(`Added to project: Status=${status}, Priority=${priority || 'not set'}`)

  format-issue-body:
    name: Clean up issue body
    runs-on: ubuntu-latest
    needs: [add-domain-label, set-issue-type, add-to-project]
    if: always()
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            let body = context.payload.issue.body || '';

            // Remove Domain, Priority, Status sections
            body = body.replace(/### Domain\s*\n\s*(Admin|API|DevOps|UI|Quant|Smart Contracts)\s*\n*/gi, '');
            body = body.replace(/### Priority\s*\n\s*(Critical|High|Medium|Low)\s*\n*/gi, '');
            body = body.replace(/### Status\s*\n\s*(Backlog|Icebox|In Progress|Blocked|None)?\s*\n*/gi, '');

            // Clean up extra newlines
            body = body.replace(/\n{3,}/g, '\n\n').trim();

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

            console.log('Cleaned up issue body')
